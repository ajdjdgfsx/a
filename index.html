<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐游戏成绩计算器</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .search-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .results-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .calculator-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input, select, button {
            padding: 8px 12px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .result-value {
            font-weight: bold;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <h1>音乐游戏成绩计算器</h1>
    
    <div class="search-container">
        <h2>搜索歌曲</h2>
        <input type="text" id="searchInput" placeholder="输入歌曲名称...">
        <button onclick="searchMusic()">搜索</button>
    </div>
    
    <div class="results-container" id="resultsContainer" style="display: none;">
        <h2>搜索结果</h2>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>歌曲ID</th>
                    <th>歌曲名称</th>
                    <th>难度</th>
                    <th>等级</th>
                    <th>音符总数</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
    </div>
    
    <div class="calculator-container" id="calculatorContainer" style="display: none;">
        <h2>成绩计算</h2>
        <div>
            <h3 id="selectedSongTitle"></h3>
            <p id="selectedDifficulty"></p>
            <p id="chartConstant"></p>
            
            <div>
                <label for="perfectInput">Perfect数量:</label>
                <input type="number" id="perfectInput" min="0">
            </div>
            <div>
                <label for="greatInput">Great数量:</label>
                <input type="number" id="greatInput" min="0">
            </div>
            <div>
                <label for="goodInput">Good数量:</label>
                <input type="number" id="goodInput" min="0">
            </div>
            <div>
                <label for="badInput">Bad数量:</label>
                <input type="number" id="badInput" min="0">
            </div>
            <div>
                <label for="missInput">Miss数量:</label>
                <input type="number" id="missInput" min="0">
            </div>
            <div>
                <label for="constantInput">谱面定数:</label>
                <input type="number" id="constantInput" step="0.1">
            </div>
            
            <button onclick="calculate()">计算</button>
            
            <div style="margin-top: 20px;">
                <h3>计算结果</h3>
                <p>ACC: <span id="accResult" class="result-value">-</span></p>
                <p>单曲Ranking: <span id="rankingResult" class="result-value">-</span></p>
            </div>
        </div>
    </div>

    <script>
        // 存储音乐和难度数据
        let musics = [];
        let difficulties = [];
        let currentSelectedSong = null;
        let currentSelectedDifficulty = null;

        // 加载JSON数据
        async function loadData() {
            try {
                const [musicsResponse, difficultiesResponse] = await Promise.all([
                    fetch('musics.json'),
                    fetch('musicDifficulties.json')
                ]);
                
                musics = await musicsResponse.json();
                difficulties = await difficultiesDifficultiesResponse.json();
                
                console.log('数据加载成功');
            } catch (error) {
                console.error('加载数据失败:', error);
                alert('加载数据失败，请检查JSON文件是否存在');
            }
        }

        // 搜索音乐
        function searchMusic() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                alert('请输入搜索内容');
                return;
            }
            
            const resultsBody = document.getElementById('resultsBody');
            resultsBody.innerHTML = '';
            
            const filteredMusics = musics.filter(music => 
                music.title.toLowerCase().includes(searchTerm) || 
                music.pronunciation.toLowerCase().includes(searchTerm)
            );
            
            if (filteredMusics.length === 0) {
                alert('没有找到匹配的歌曲');
                return;
            }
            
            // 显示匹配的歌曲及其难度
            filteredMusics.forEach(music => {
                const songDifficulties = difficulties.filter(diff => diff.musicId === music.id);
                
                songDifficulties.forEach(diff => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${music.id}</td>
                        <td>${music.title}</td>
                        <td>${diff.musicDifficulty}</td>
                        <td>${diff.playLevel}</td>
                        <td>${diff.totalNoteCount}</td>
                        <td><button onclick="selectSong(${music.id}, '${diff.musicDifficulty}')">选择</button></td>
                    `;
                    
                    resultsBody.appendChild(row);
                });
            });
            
            document.getElementById('resultsContainer').style.display = 'block';
        }

        // 选择歌曲和难度
        function selectSong(musicId, difficulty) {
            currentSelectedSong = musics.find(m => m.id === musicId);
            currentSelectedDifficulty = difficulties.find(d => 
                d.musicId === musicId && d.musicDifficulty === difficulty
            );
            
            document.getElementById('selectedSongTitle').textContent = `歌曲: ${currentSelectedSong.title}`;
            document.getElementById('selectedDifficulty').textContent = `难度: ${difficulty}`;
            document.getElementById('chartConstant').textContent = `谱面定数: ${currentSelectedDifficulty.playLevel}`;
            document.getElementById('constantInput').value = currentSelectedDifficulty.playLevel;
            
            document.getElementById('calculatorContainer').style.display = 'block';
        }

        // 计算ACC和Ranking
        function calculate() {
            const perfect = parseInt(document.getElementById('perfectInput').value) || 0;
            const great = parseInt(document.getElementById('greatInput').value) || 0;
            const good = parseInt(document.getElementById('goodInput').value) || 0;
            const bad = parseInt(document.getElementById('badInput').value) || 0;
            const miss = parseInt(document.getElementById('missInput').value) || 0;
            const constant = parseFloat(document.getElementById('constantInput').value) || 0;
            
            // 计算ACC
            const totalNotes = perfect + great + good + bad + miss;
            if (totalNotes === 0) {
                alert('请输入至少一个判定数量');
                return;
            }
            
            const acc = (perfect * 1 + great * 0.75 + good * 0.5 + bad * 0 + miss * 0) / totalNotes;
            
            // 计算单曲Ranking
            const ranking = Math.pow((100 * acc - 55) / 45, 2) * constant;
            
            // 显示结果
            document.getElementById('accResult').textContent = `${(acc * 100).toFixed(2)}%`;
            document.getElementById('rankingResult').textContent = ranking.toFixed(2);
        }

        // 页面加载时初始化数据
        window.onload = loadData;
    </script>
</body>
</html>